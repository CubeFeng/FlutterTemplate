# coding: utf-8
# encodng: utf-8
# -*- coding: utf-8 -*-
# vim:set fileencoding=utf-8:
require "base64"
require 'yaml'
require 'fileutils'

default_platform(:ios)

import "FastfileHelper"
import "CodeSign"

platform :ios do
  desc "Wallet App"

  @@appName = "Wallet"
  @@codeSign = nil
  @@apiEnv = nil
  @@platform = nil
  @@buildIndex = 0
  @@appRootPath = nil
  @@buildPath = nil

  # æ‰€æœ‰åŠ¨ä½œå‰çš„å‡†å¤‡å·¥ä½œ
  before_all do | lane, options |
    # é¡¹ç›®æ ¹ç›®å½•
    @@appRootPath = File.expand_path("..", Dir.pwd)

    # api ç¯å¢ƒ
    @@apiEnv = options[:apiEnv]

    # å¹³å°ç±»å‹
    @@platform = options[:platform]

    # ç­¾åã€è¯ä¹¦
    _type = @@apiEnv == 'prod' ? 'release' : 'development'
    @@codeSign = CodeSign.new(_type, @@platform)

    # åˆ›å»º app_builds æ–‡ä»¶å¤¹
    @@buildPath = "#{@@appRootPath}/app_builds"
    if !File.directory?(@@buildPath)
      Dir.mkdir(@@buildPath)
    end

    # Dir.chdir "../ios/" do
      # sh("export https_proxy=http://127.0.0.1:6152;export http_proxy=http://127.0.0.1:6152;export all_proxy=socks5://127.0.0.1:6153")
      # sh("pod", "repo", "update")
    # end
  end

  #
  lane :test do | options |

  end

  # æ„å»ºapp
  # @params string apiEnv APIç¯å¢ƒ dev/test/pre/prod/custom
  # @params string platform æ„å»ºå¹³å° iOS/Android
  lane :build_flutter_app do | options |
    # æ–‡ä»¶è¾“å‡ºåç§°
    _outFileName = get_app_out_name(@@appName, @@apiEnv)
    UI.message "[BUILD APP] #{@@buildIndex += 1}. ç”Ÿæˆæ–‡ä»¶å¯¼å‡ºåç§°, #{_outFileName}"

    # æ›´æ–° app ç‰ˆæœ¬å·
    _appversion = update_flutter_app_version(false)
    UI.message "[BUILD APP] #{@@buildIndex += 1}. æ›´æ–°appç‰ˆæœ¬å·: #{_appversion}"

    UI.message "[BUILD APP] #{@@buildIndex += 1}. æ›´æ–°Appçš„Apiç¯å¢ƒ, env: #{@@apiEnv}"
    update_app_api_env(@@apiEnv)

    _short_hash = last_git_commit[:abbreviated_commit_hash]
    UI.message "[BUILD APP] #{@@buildIndex += 1}. æ›´æ–°Appé…ç½®æ–‡ä»¶"
    update_app_config_json(@@platform, _short_hash)

    options[:outFileName] = _outFileName

    # æ ¹æ®å·¥ç¨‹åˆ‡æ¢ flutter ç‰ˆæœ¬
    sh("fvm", "flavor", "stable")

    UI.message "[Flutter Build] #{@@buildIndex += 1}. æ¸…ç©ºç¼“å­˜"
    sh("fvm", "flutter", "clean", "--no-version-check")

    UI.message "[Flutter Build] #{@@buildIndex += 1}. æ‹‰å–ç¬¬ä¸‰æ–¹æ’ä»¶"
    sh("fvm", "flutter", "pub", "get", "--no-version-check")
    
    UI.message "[BUILD APP] #{@@buildIndex += 1}. æ›´æ”¹Appçš„å›¾æ ‡"
    update_app_icon(@@apiEnv, @@platform)
    
    UI.message "[BUILD APP] #{@@buildIndex += 1}. æ³¨å…¥Umengç»Ÿè®¡"
    inject_umeng_plugin(@@apiEnv)

    UI.message "[Flutter Build] #{@@buildIndex += 1}. æ›´æ–°FlutterAppé…ç½®"
    update_flutter_app_config(@@apiEnv, @@platform, @@codeSign.bundle_identifier)

    case @@platform
    when 'iOS'
      app_path = build_ios(options)
    when 'Android'
      app_path = build_android(options)
    end

    UI.message "[Flutter Build] #{@@buildIndex += 1}. å†™å…¥appæ–‡ä»¶åˆ°ç¯å¢ƒå˜é‡ APP_FILE_PATH ä¸­"

    write_config_yaml_data(@@platform, 'app_path', app_path)
  end

  # æ‰“åŒ… iOS
  lane :build_ios do | options |
    _outFileName = options[:outFileName]

    UI.message "[Flutter Build] #{@@buildIndex += 1}. å› å­˜åœ¨å¤šåŒ…å, æ›´æ–°Info.plist !"
    Dir.chdir "../ios/" do
      update_info_plist(
        xcodeproj: "#{Dir.pwd}/#{ENV["XCODEPROJ"]}",
        plist_path: "Runner/Info.plist",
        app_identifier: @@codeSign.bundle_identifier
      )
    end

    UI.message "[Flutter Build] #{@@buildIndex += 1}. ä¸ºäº†ä¿è¯æè¿°æ–‡ä»¶å¯ç”¨, å…ˆè¿›è¡Œåˆ é™¤æ“ä½œ"
    remove_provisioning_profile(app_identifier: @@codeSign.bundle_identifier, type: @@codeSign.type)
    UI.message "[Flutter Build] #{@@buildIndex += 1}. é€šè¿‡matchè·å–æœ€æ–°çš„è¯ä¹¦åŠæè¿°æ–‡ä»¶"
    match(
      type: @@codeSign.type,
      app_identifier: @@codeSign.bundle_identifier,
      keychain_password: ENV["KEYCHAIN_PASSWORD"],
      readonly: true
    )

    UI.message "[Flutter Build] #{@@buildIndex += 1}. æ›´æ–°ç­¾åé…ç½®"
    Dir.chdir "../ios/" do
      update_code_signing_settings(
        use_automatic_signing: false,
        path: "#{Dir.pwd}/#{ENV["XCODEPROJ"]}",
        team_id: CredentialsManager::AppfileConfig.try_fetch_value(:team_id),
        code_sign_identity: @@codeSign.code_sign_identity,
        profile_name: @@codeSign.profile_name
      )
    end

    sh("fvm", "flutter", "precache", "--ios")

    update_export_options(options)

    UI.message "[Flutter Build] #{@@buildIndex += 1}. æ ¹æ®ç¯å¢ƒé€‰æ‹© toolchain"
    _toolchain = "com.apple.dt.toolchain.XcodeDefault"

    UI.message "[Flutter Build] #{@@buildIndex += 1}. ç¼–è¯‘å¹¶å¯¼å‡ºæœ€ç»ˆäº§ç‰©"

    sh("fvm", "flutter", "build", "ipa",
      "--bundle-sksl-path", "sksl/flutter_ios_01.sksl.json",
      "--export-options-plist=fastlane/ExportOptions.plist",
      "--no-version-check"
    )

    _xcarchive_path = "#{@@appRootPath}/build/ios/archive/Runner.xcarchive"
    if @@apiEnv == 'prod'
      UI.message "[Flutter Build] #{@@buildIndex += 1}. ä¸Šä¼ archiveæ–‡ä»¶åˆ°minioæœåŠ¡å™¨"
      sh('chmod', '755', "#{@@appRootPath}/fastlane/minio.sh")
      zip(path: _xcarchive_path, verbose: false)
      sh("#{@@appRootPath}/fastlane/minio.sh #{_outFileName}.xcarchive.zip #{_xcarchive_path}.zip")
      FileUtils.rm_rf("#{_xcarchive_path}.zip")
    end
    FileUtils.rm_rf(_xcarchive_path)

    ipaFilePath = Dir[ "#{@@appRootPath}/build/ios/ipa/*.ipa" ].select{ |f| File.absolute_path f }
    sh("mv", ipaFilePath[0], "#{@@buildPath}/#{_outFileName}.ipa")

    UI.message "âœ…æ„å»ºå®ŒæˆğŸ‰!"
    # è¿”å›æ–‡ä»¶åç§°
    ipaFile = "app_builds/#{_outFileName}.ipa"
  end

  # æ›´æ–°iOSå¯¼å‡ºé…ç½®
  lane :update_export_options do | options |
    update_plist(
      plist_path: "fastlane/ExportOptions.plist",
      block: proc do |plist|
        plist["method"] = @@codeSign.export_method
        plist["provisioningProfiles"] = {
          @@codeSign.bundle_identifier => @@codeSign.profile_name,
        }
        plist["teamID"] = ENV["TEAM_ID"]
      end
    )
  end

  # æ‰“åŒ… Android
  lane :build_android do | options |
    _outFileName = options[:outFileName]

    Dir.chdir "../" do
      UI.message "[Flutter Build] #{@@buildIndex += 1}. ç¼–è¯‘å¹¶å¯¼å‡ºæœ€ç»ˆäº§ç‰©"
      sh("fvm", "flutter", "build", "apk",
        "--target-platform", "android-arm",
        "--split-per-abi",
        "--no-version-check",
        "--bundle-sksl-path", "sksl/flutter_android_01.sksl.json",
      )

      apkFile = "build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk"

      UI.message "[Flutter Build] #{@@buildIndex += 1}. ç§»åŠ¨apkæ–‡ä»¶åˆ°æŒ‡å®šç›®å½•"
      sh("mv #{apkFile} app_builds/#{_outFileName}.apk")
    end
    UI.message "âœ…æ„å»ºå®ŒæˆğŸ‰!"
    apkFile = "app_builds/#{_outFileName}.apk"
  end

  # ä¸Šä¼ app
  # @params string platform å¹³å°
  lane :upload_app do | options |

    _platform = options[:platform]
    _app_path = read_config_yaml_data(_platform, 'app_path')

    Dir.chdir "../" do
      _app_path = "#{Dir.pwd}/#{_app_path}"
    end

    uri = URI(ENV["APP_UPLOAD_API"])

    info = upload_file(_app_path)

    if info['code'] == 0
      UI.user_error!("æ–‡ä»¶ä¸Šä¼ é”™è¯¯!!!")
    end

    puts "ç”Ÿæˆçš„çŸ­é“¾æ¥ä¸º: #{info['data']['url']}"

    app_url = info['data']['url']
    write_config_yaml_data(_platform, 'app_url', app_url)
  end

  # å‘é€æ¶ˆæ¯åˆ°æ„å»ºç³»ç»Ÿ
  # fastlane releaseApp id:12 url:xxx platform:ANDROID
  lane :release_app do | options |
    _platform = options[:platform]
    _url = read_config_yaml_data(_platform, 'app_url')

    con = Faraday.new ENV["APP_RELEASE_API"]
    params = {
      :id => options[:id],
      :url => _url,
      :platform => options[:platform],
    }
    puts params
    res = con.post '', params
    puts "æœåŠ¡å™¨è¿”å›"
    puts res.body
  end

  # æäº¤æ›´æ”¹
  lane :commit_change do | options |
    UI.message "[COMMIT] 1. æäº¤æ›´æ–°åçš„ç‰ˆæœ¬å·!"
    sh("git fetch origin #{git_branch()}")
    update_flutter_app_version(true)
  end
end



